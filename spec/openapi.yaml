openapi: 3.1.0
info:
  title: Todo + Comments API
  version: 0.1.0
servers:
  - url: http://localhost
paths:
  /todos:
    get:
      summary: List Todos
      operationId: listTodos
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Todo'
    post:
      summary: Create a Todo
      operationId: createTodo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TodoCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Todo'
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
  /todos/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string }
    get:
      summary: Get a Todo by id
      operationId: getTodo
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Todo'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      summary: Update a Todo by id
      operationId: updateTodo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TodoUpdate'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Todo'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
  /todos/{id}/comments:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string }
    get:
      summary: List comments for a Todo
      operationId: listComments
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Comment'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      summary: Add a comment to a Todo
      operationId: createComment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Business rule violation â€” cannot add a comment to a done Todo
          headers:
            Content-Type:
              schema: { type: string, example: application/json }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                doneTodo:
                  value:
                    code: todo.comment.forbidden_on_done
                    message: Cannot add a comment to a completed Todo.
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

components:
  schemas:
    Status:
      type: string
      enum: [open, done]
      description: Current state of the Todo
    Todo:
      type: object
      required: [id, title, status, createdAt, updatedAt]
      properties:
        id:
          type: string
        title:
          type: string
          minLength: 1
          maxLength: 200
        status:
          $ref: '#/components/schemas/Status'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    TodoCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
    TodoUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        status:
          $ref: '#/components/schemas/Status'
    Comment:
      type: object
      required: [id, todoId, message, createdAt]
      properties:
        id:
          type: string
        todoId:
          type: string
        message:
          type: string
          minLength: 1
          maxLength: 2000
        createdAt:
          type: string
          format: date-time
    CommentCreate:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 2000
    Error:
      type: object
      required: [code, message]
      properties:
        code: { type: string }
        message: { type: string }
        details:
          type: object
          additionalProperties: true
          nullable: true
    ValidationError:
      allOf:
        - $ref: '#/components/schemas/Error'
        - type: object
          properties:
            details:
              type: object
              additionalProperties:
                type: array
                items: { type: string }
              description: Field-wise validation errors
